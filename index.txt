let{createServer,get:gg}=require("http"),{spawn}=require("child_process"),{parse}=require("url"),{PORT,KEY,DB}=process.env,{wow,rc,rt,ct,aj,u}=require("./a.json");j=(e=>JSON.stringify(e)),p=(e=>JSON.parse(e));class Mongo{constructor(){this.m=spawn("mongo",[DB]),this.ch=[],this.rd=!1,this.m.stdout.on("data",e=>{let t=[e.toString().replace(/\n/g,"")];if(t[0].includes(",1!")&&(t=[...t[0].split(",1!").filter(e=>e).map(e=>p(e))]),this.rd)return this.ch.push(...t);t[0].includes("3.6.6")&&(this.rd=!0)})}q(e,t=1){return this.ch=[],new Promise(r=>{for(;!this.rd;);this.m.stdin.write(`${e};\n`);let i=setInterval(()=>{if(this.ch.length>=t){if(clearInterval(i),1===t)return r(this.ch[0]);r(this.ch)}},1)})}async c(e,t=""){return this.q(`db.${e}.find(${t}).count()`)}async fa(e){let t=await this.c(e);return this.q(`db.${e}.find()${wow}`,t)}async fq(e,t){let r=await this.c(e,t);return this.q(`db.${e}.find(${t})${wow}`,r)}async i(e,t){return(await this.q(`db.${e}.insertOne(${t})`)).match(/insertedId" : ObjectId\(\"(\w+)\"/)[1]}}let mo=new Mongo,hp=async e=>{if(e.headers[ct]!==aj)return Promise.reject();let t="";return new Promise(r=>{e.on("data",e=>{t+=e.toString()}),e.on("end",()=>{r(p(t))})})},rq=async e=>new Promise((t,r)=>{let i="";gg(e,e=>{e.on("data",e=>{i+=e.toString()}),e.on("end",()=>{i&&"Title"in p(i)||r("Not found"),t(p(i))})})});nf=(e=>{e.statusCode=404,e.end(j({error:"not found"}))}),mg=(e=>"GET"===e),mp=(e=>"POST"===e);let server=createServer(async(e,t)=>{t.setHeader(ct,aj);let{url:r,method:i}=e,{query:n,pathname:s}=parse(r,!0);switch(t.statusCode=200,s){case"/movies":if(mg(i)){let e=await mo.fa("movies");t.end(j(e))}if(mp(i)){let{title:r}=await hp(e);if(!r)return t.end(j({err:rt}));try{let e=await rq(`${u}=${KEY}&t=${r}`),i=await mo.i("movies",j(e));t.end(j({_id:i,...e}))}catch(e){nf(t)}}break;case"/comments":let{id:r}=n;if(mg(i)&&r){let e=await mo.fq("comments",`{"movieId":"${r}"}`);t.end(j(e))}if(mg(i)&&!r){let e=await mo.fa("comments");t.end(j(e))}if(mp(i)){let{movieId:r,body:i}=await hp(e);if(!r||!i)return t.end(j({err:rc}));let n=await mo.i("comments",j({movieId:r,body:i}));t.end(j({_id:n,movieId:r,body:i}))}break;default:nf(t)}});server.listen(PORT);
